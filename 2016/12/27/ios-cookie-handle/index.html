<!DOCTYPE html><html lang=""><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> [iOS 开发]如何处理 iOS 原生网络请求中的 cookie ？ · Shannon's Blog</title><meta name="description" content="[iOS 开发]如何处理 iOS 原生网络请求中的 cookie ？ - ShannonChenCHN"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Shannon's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="https://github.com/ShannonChenCHN" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">[iOS 开发]如何处理 iOS 原生网络请求中的 cookie ？</h1><div class="post-info">Dec 27, 2016</div><div class="post-content"><blockquote>
<p><strong>时间</strong>：2016.12.26<br><strong>背景</strong>：在 iOS 开发中，大部分应用的用户登录机制都是基于 token 令牌的，我之前做过的项目也都是如此，但是在我现在的新项目中，由于服务端同学是沿用他们以前的 cookie 登录机制，所以我也不得不换种方式来对（zhe）待（teng）登（yi）录（xia）问题了。</p>
</blockquote>
<p><strong>1.什么是 cookie？cookie 和 token 有何区别？</strong><br>cookie 是什么呢？cookie 在英语中通常是指饼干，当然，我这里指的不是，而是 HTTP 网络请求中用来记录用户信息的一种数据形式或者说一种机制。</p>
<p><strong>cookie</strong>：在客户端发送登录操作的网络请求时，服务器在登陆成功返回的 response header 中会添加一个 set-cookie 的值，作为用户的身份认证，如果是浏览器的话，后面每一次发请求时，浏览器都会自动将之前获取到的 cookie 值插入到 request header 的 cookie 字段中，而且 cookie 本身包括多个属性，比如有效期 expires、域 domain等，因此采用 cookie 的登录机制需要考虑到对 cookie 本身的管理。cookie 主要是在 web 领域使用。</p>
<p><strong>token</strong>：相比 cookie，token 令牌的登录机制要更轻，直观的感受是，登录认证成功后，服务器返回 token 值，然后在请求的 url 中拼接一段 “token=%^&amp;%#&amp;%#&amp;” 就完事了，至于什么跨域、安全策略什么的，根本没他什么事，客户端管理 token 也非常简单，只要看好这个字符串就行了，所以 token 一般在移动端用的比较多。当然，移动应用中的 web view 还是要处理 cookie 的。</p>
<p><strong>2.iOS 中的网络请求中如何处理 cookie？</strong><br>在开始处理 cookie 时，需要了解两个类，NSHTTPCookie 和 NSHTTPCookieStorage，在用的时候要注意几点：</p>
<blockquote>
<ul>
<li>在请求时，NSURLSession 和 NSURLConnection 会自动帮我们管理 cookie 的，但并不完善。AFNetworking 默认设置了 NSURLRequest 的 HTTPShouldHandleCookies 属性为 YES。</li>
<li>如果服务器设置了 Cookie 失效时间 expiresDate，并且 sessionOnly 为 FALSE，Cookie 就会被持久化到文件中，下次启动app会自动加载沙盒中的 Cookies。如果 sessionOnly 为 TRUE 或者 expiresDate 为空，则不会自动持久化到沙盒。</li>
<li>手动设置的 Cookie 不会被 NSHTTPCookieStorage 自动持久化到沙盒。</li>
<li>不能简单地依赖 NSHTTPCookieStorage 的 setCookie: 方法来做 cookie 的存储，因为在执行 setCookie：时， cookie 并不是马上就更新了。参考： <a href="http://stackoverflow.com/questions/5837702/nshttpcookiestorage-state-not-saved-on-app-exit-any-definitive-knowledge-docume" target="_blank" rel="noopener">NSHTTPCookieStorage state not saved on app exit. Any definitive knowledge/documentation out there?</a></li>
<li>cookie 的 httpOnly 属性是用来设置 cookie 是否能通过 js 去访问。默认情况下，cookie不会带httpOnly选项(即为空)，所以默认情况下，客户端是可以通过 js 代码去访问（包括读取、修改、删除等）这个cookie的。当cookie带 httpOnly 选项时，客户端则无法通过js代码去访问（包括读取、修改、删除等）这个cookie。参考：<a href="https://segmentfault.com/a/1190000004556040" target="_blank" rel="noopener">聊一聊 cookie</a>。</li>
</ul>
</blockquote>
<p>下面切入正题吧，我是如何做的呢？<br>首先是登录。登录成功后，服务器在 HTTP response header 中的 set-cookie 字段中返回了 cookie 的值，我们可已通过多种方式获取到我们想要的 cookie 值，我是采用了下面这种方式来读取的，因为我们的服务器没有设置 expireDate，所以我就自己做持久化存储了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NSDictionary *headerFields = [(NSHTTPURLResponse *)response allHeaderFields];</span><br><span class="line">    NSArray &lt;NSHTTPCookie *&gt; *cookies =[NSHTTPCookieStorage sharedHTTPCookieStorage].cookies;  // 只要服务器在请求返回时带了 cookie，NSHTTPCookieStorage 就会自动帮我们管理 cookie</span><br><span class="line">    DDLogDebug(@&quot;\n shared cookies %@\n&quot;, cookies);</span><br><span class="line">    </span><br><span class="line">    for (NSHTTPCookie *aCookie in cookies) &#123;</span><br><span class="line">        if ([aCookie.name isEqualToString:@&quot;BUA&quot;]) &#123;  // 获取并保存用户cookie</span><br><span class="line">           [[NSUserDefaults standardUserDefaults] setObject:cookie.properties forKey:kYIDUserDefaultUserCookieKey]; // 自己做持久化存储</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后是请求时添加 cookie 到 request header。实际上这一步系统（NSURLSession / NSURLConnection）已经自动帮我们处理了，具体细节我也不太清楚。</p>
<p>还要考虑重启应用后的操作，由于我们的服务器没有设置 expireDate 以及上面提到的其他原因，在程序重启时，NSHTTPCookieStorage 并不会保存上一次使用应用时的 cookie，所以我们需要在程序启动时读取自己保存的 cookie，同时更新 NSHTTPCookieStorage 的 cookie。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123; &#123;</span><br><span class="line">    NSDictionary *cookieProperties = [[NSUserDefaults standardUserDefaults] objectForKey:kYIDUserDefaultUserCookieKey];</span><br><span class="line">    NSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:cookieProperties];</span><br><span class="line">    [[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie];</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 cookie 的有效期处理，在使用 cookie 时需要自己判断 cookie 是否过期，NSHTTPCookieStorage 是不会自动帮我们处理的，更何况我们自己还做了本地存储，所以我们在用到 cookie 时还需要检查 cookie 是否过期，如果过期了，就要废弃掉失效的 cookie。我是在用户的登录状态方法中做的处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)isLoggedIn &#123;</span><br><span class="line">    </span><br><span class="line">    if (![self.cookie yid_isNotExpired]) &#123; // cookie 失效，自动退出登录</span><br><span class="line">        [self logout];  // 删除用户信息、cookie</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return [self.cookie yid_isNotEmpty];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后还要记得在退出登录时也要删除 cookie：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[[NSHTTPCookieStorage sharedHTTPCookieStorage] deleteCookie:[self userCookie]];</span><br><span class="line">[[NSUserDefaults standardUserDefaults] removeObjectForKey:kYIDUserDefaultUserCookieKey];</span><br></pre></td></tr></table></figure>
<p><strong>3.iOS 中的原生网络请求如何与 webView 实现 cookie 共享？</strong></p>
<ul>
<li><p>UIWebView 是属于 URL Loading System 的一部分，所以系统会自动帮我们将 NSHTTPCookieStorage  中的 cookie 同步到 UIWebView 中去。</p>
</li>
<li><p>由于 WKWebView 是独立于 URL Loading System 之外的，所以 WKWebView 所有的 cookie 管理都需要开发者自己操作，具体方法可以参考 stackoverflow 上的解决方案：<a href="http://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview/32845148#32845148" target="_blank" rel="noopener">Can I set the cookies to be used by a WKWebView?</a>，也有国内开发者根据这个答案造了一个轮子 <a href="https://github.com/haifengkao/YWebView" target="_blank" rel="noopener">haifengkao/YWebView</a>。</p>
</li>
</ul>
<p>遗留问题：<br>1.服务器是在什么时候更新/生成cookie ？<br>2.登陆成功后，系统是如何自动添加 cookie 到 request  header 中去的？<br>3.服务器是怎么识别客户端的 cookie 的？</p>
<blockquote>
<p><strong>参考资料</strong>：</p>
<ol>
<li>Wikipedia - HTTP cookie：<br><a href="https://en.wikipedia.org/wiki/HTTP_cookie" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/HTTP_cookie</a></li>
<li>聊一聊 cookie：<br><a href="https://segmentfault.com/a/1190000004556040" target="_blank" rel="noopener">https://segmentfault.com/a/1190000004556040</a></li>
<li>NSHTTPCookieStorage 官方文档：<br><a href="https://developer.apple.com/reference/foundation/nshttpcookiestorage" target="_blank" rel="noopener">https://developer.apple.com/reference/foundation/nshttpcookiestorage</a><br>中文版：<a href="http://www.jianshu.com/p/b10652a1803e" target="_blank" rel="noopener">http://www.jianshu.com/p/b10652a1803e</a></li>
<li>iOS平台下cookie的使用：<br><a href="http://www.jianshu.com/p/65094611980c" target="_blank" rel="noopener">http://www.jianshu.com/p/65094611980c</a></li>
<li>iOS HTTP网络请求Cookie的读取与写入(NSHTTPCookieStorage)<br><a href="http://www.skyfox.org/ios-url-request-cookie.html" target="_blank" rel="noopener">http://www.skyfox.org/ios-url-request-cookie.html</a></li>
<li>NSHTTPCookieStorage state not saved on app exit. Any definitive knowledge/documentation out there?<br><a href="http://stackoverflow.com/questions/5837702/nshttpcookiestorage-state-not-saved-on-app-exit-any-definitive-knowledge-docume" target="_blank" rel="noopener">http://stackoverflow.com/questions/5837702/nshttpcookiestorage-state-not-saved-on-app-exit-any-definitive-knowledge-docume</a></li>
<li>app开发token、cookie的区别，账号密码加密又是如何保证安全？<br><a href="https://www.zhihu.com/question/39137156" target="_blank" rel="noopener">https://www.zhihu.com/question/39137156</a></li>
<li>为什么 APP 要用 token 而不用 session 认证？<br><a href="https://www.v2ex.com/t/148426" target="_blank" rel="noopener">https://www.v2ex.com/t/148426</a></li>
<li>How to manage sessions with AFNetworking?<br><a href="http://stackoverflow.com/questions/10984374/how-to-manage-sessions-with-afnetworking/11039784#11039784" target="_blank" rel="noopener">http://stackoverflow.com/questions/10984374/how-to-manage-sessions-with-afnetworking/11039784#11039784</a></li>
<li>Persisting Cookies In An iOS Application?<br><a href="http://stackoverflow.com/questions/4597763/persisting-cookies-in-an-ios-application" target="_blank" rel="noopener">http://stackoverflow.com/questions/4597763/persisting-cookies-in-an-ios-application</a></li>
<li>NSHTTPCookieStorage and Cookie Expiration Date<br><a href="http://stackoverflow.com/questions/7203641/nshttpcookiestorage-and-cookie-expiration-date/7209706#7209706" target="_blank" rel="noopener">http://stackoverflow.com/questions/7203641/nshttpcookiestorage-and-cookie-expiration-date/7209706#7209706</a></li>
<li>Can I set the cookies to be used by a WKWebView?<a href="http://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview" target="_blank" rel="noopener">http://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview</a></li>
<li>haifengkao/YWebView：<a href="https://github.com/haifengkao/YWebView" target="_blank" rel="noopener">https://github.com/haifengkao/YWebView</a></li>
</ol>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/03/2016-review/" class="prev">上一篇</a><a href="/2016/07/03/ios-calendar-bug/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">ShannonChenCHN</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>